apiVersion: v1
kind: ConfigMap
metadata:
  name: localai-image-proxy-config
  namespace: ai-stack
data:
  server.py: |
    import base64
    import json
    import os
    import random
    import time
    from typing import Any, Dict, List, Optional, Tuple

    import requests
    from fastapi import FastAPI, File, Form, HTTPException, UploadFile
    from fastapi.responses import JSONResponse

    app = FastAPI(title="openai-comfyui-image-proxy")

    COMFYUI_BASE_URL = os.getenv("COMFYUI_BASE_URL", "http://comfyui:8188").rstrip("/")
    COMFYUI_DEFAULT_CHECKPOINT = os.getenv(
        "COMFYUI_DEFAULT_CHECKPOINT", "DreamShaper_8_pruned.safetensors"
    )
    COMFYUI_DEFAULT_NEGATIVE = os.getenv(
        "COMFYUI_DEFAULT_NEGATIVE_PROMPT",
        "low quality, blurry, artifacts, watermark, text",
    )
    COMFYUI_DEFAULT_STEPS = int(os.getenv("COMFYUI_DEFAULT_STEPS", "28"))
    COMFYUI_DEFAULT_CFG = float(os.getenv("COMFYUI_DEFAULT_CFG", "7.0"))
    COMFYUI_DEFAULT_DENOISE = float(os.getenv("COMFYUI_DEFAULT_DENOISE", "0.55"))
    COMFYUI_DEFAULT_SAMPLER = os.getenv("COMFYUI_DEFAULT_SAMPLER", "euler")
    COMFYUI_DEFAULT_SCHEDULER = os.getenv("COMFYUI_DEFAULT_SCHEDULER", "normal")
    COMFYUI_TIMEOUT_SECONDS = int(os.getenv("COMFYUI_TIMEOUT_SECONDS", "300"))
    COMFYUI_POLL_SECONDS = float(os.getenv("COMFYUI_POLL_SECONDS", "1.0"))
    COMFYUI_OUTPUT_PREFIX = os.getenv("COMFYUI_OUTPUT_PREFIX", "openwebui")

    def _parse_model_map() -> Dict[str, str]:
        raw = os.getenv("COMFYUI_MODEL_MAP", "").strip()
        if not raw:
            return {}
        try:
            parsed = json.loads(raw)
            if isinstance(parsed, dict):
                return {str(k): str(v) for k, v in parsed.items()}
        except Exception:
            pass
        mapped = {}
        for pair in raw.split(","):
            if "=" not in pair:
                continue
            key, value = pair.split("=", 1)
            key = key.strip()
            value = value.strip()
            if key and value:
                mapped[key] = value
        return mapped

    MODEL_MAP = _parse_model_map()

    def _size_to_dims(size: Optional[str]) -> Tuple[int, int]:
        default_w, default_h = 1024, 1024
        if not size:
            return default_w, default_h
        try:
            width_s, height_s = size.lower().split("x", 1)
            width = max(256, min(2048, int(width_s)))
            height = max(256, min(2048, int(height_s)))
            return width, height
        except Exception:
            return default_w, default_h

    def _resolve_checkpoint(model_name: Optional[str]) -> str:
        if not model_name:
            return COMFYUI_DEFAULT_CHECKPOINT
        model_name = str(model_name).strip()
        if not model_name:
            return COMFYUI_DEFAULT_CHECKPOINT
        if model_name in MODEL_MAP:
            return MODEL_MAP[model_name]
        if model_name.endswith((".safetensors", ".ckpt", ".pt", ".pth", ".bin")):
            return model_name
        return COMFYUI_DEFAULT_CHECKPOINT

    def _comfy_post(path: str, payload: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        url = f"{COMFYUI_BASE_URL}{path}"
        try:
            response = requests.post(url, json=payload, timeout=COMFYUI_TIMEOUT_SECONDS)
        except Exception as exc:
            raise HTTPException(status_code=502, detail=f"ComfyUI request failed: {exc}")
        if response.status_code >= 400:
            raise HTTPException(
                status_code=502,
                detail=f"ComfyUI error {response.status_code}: {response.text[:300]}",
            )
        try:
            return response.json()
        except Exception:
            return {}

    def _comfy_get(path: str, params: Optional[Dict[str, Any]] = None, raw: bool = False):
        url = f"{COMFYUI_BASE_URL}{path}"
        try:
            response = requests.get(url, params=params, timeout=COMFYUI_TIMEOUT_SECONDS)
        except Exception as exc:
            raise HTTPException(status_code=502, detail=f"ComfyUI request failed: {exc}")
        if response.status_code >= 400:
            raise HTTPException(
                status_code=502,
                detail=f"ComfyUI error {response.status_code}: {response.text[:300]}",
            )
        if raw:
            return response.content
        try:
            return response.json()
        except Exception:
            return {}

    def _queue_prompt(workflow: Dict[str, Any]) -> str:
        payload = {"prompt": workflow}
        response = _comfy_post("/prompt", payload)
        prompt_id = response.get("prompt_id")
        if not prompt_id:
            raise HTTPException(status_code=502, detail="ComfyUI did not return prompt_id")
        return str(prompt_id)

    def _collect_images_from_history(history_entry: Dict[str, Any]) -> List[Dict[str, Any]]:
        images: List[Dict[str, Any]] = []
        outputs = history_entry.get("outputs", {}) if isinstance(history_entry, dict) else {}
        if not isinstance(outputs, dict):
            return images
        for node_output in outputs.values():
            if not isinstance(node_output, dict):
                continue
            node_images = node_output.get("images")
            if not isinstance(node_images, list):
                continue
            for image in node_images:
                if isinstance(image, dict) and image.get("filename"):
                    images.append(image)
        return images

    def _wait_for_images(prompt_id: str) -> List[Dict[str, Any]]:
        deadline = time.time() + COMFYUI_TIMEOUT_SECONDS
        while time.time() < deadline:
            history = _comfy_get(f"/history/{prompt_id}")
            entry = history.get(prompt_id) if isinstance(history, dict) else None
            if isinstance(entry, dict):
                images = _collect_images_from_history(entry)
                if images:
                    return images
            time.sleep(COMFYUI_POLL_SECONDS)
        raise HTTPException(status_code=504, detail="Timed out waiting for ComfyUI output")

    def _fetch_image_b64(image_ref: Dict[str, Any]) -> str:
        params = {
            "filename": image_ref.get("filename", ""),
            "subfolder": image_ref.get("subfolder", ""),
            "type": image_ref.get("type", "output"),
        }
        content = _comfy_get("/view", params=params, raw=True)
        return base64.b64encode(content).decode("ascii")

    def _build_text2img_workflow(
        checkpoint: str,
        prompt: str,
        negative_prompt: str,
        width: int,
        height: int,
        seed: int,
        steps: int,
        cfg: float,
        n: int,
    ) -> Dict[str, Any]:
        return {
            "1": {"class_type": "CheckpointLoaderSimple", "inputs": {"ckpt_name": checkpoint}},
            "2": {
                "class_type": "CLIPTextEncode",
                "inputs": {"text": prompt, "clip": ["1", 1]},
            },
            "3": {
                "class_type": "CLIPTextEncode",
                "inputs": {"text": negative_prompt, "clip": ["1", 1]},
            },
            "4": {
                "class_type": "EmptyLatentImage",
                "inputs": {"width": width, "height": height, "batch_size": max(1, min(4, n))},
            },
            "5": {
                "class_type": "KSampler",
                "inputs": {
                    "seed": seed,
                    "steps": steps,
                    "cfg": cfg,
                    "sampler_name": COMFYUI_DEFAULT_SAMPLER,
                    "scheduler": COMFYUI_DEFAULT_SCHEDULER,
                    "denoise": 1.0,
                    "model": ["1", 0],
                    "positive": ["2", 0],
                    "negative": ["3", 0],
                    "latent_image": ["4", 0],
                },
            },
            "6": {"class_type": "VAEDecode", "inputs": {"samples": ["5", 0], "vae": ["1", 2]}},
            "7": {
                "class_type": "SaveImage",
                "inputs": {"filename_prefix": COMFYUI_OUTPUT_PREFIX, "images": ["6", 0]},
            },
        }

    def _build_img2img_workflow(
        checkpoint: str,
        prompt: str,
        negative_prompt: str,
        uploaded_image_name: str,
        seed: int,
        steps: int,
        cfg: float,
        denoise: float,
        n: int,
    ) -> Dict[str, Any]:
        return {
            "1": {"class_type": "CheckpointLoaderSimple", "inputs": {"ckpt_name": checkpoint}},
            "2": {
                "class_type": "CLIPTextEncode",
                "inputs": {"text": prompt, "clip": ["1", 1]},
            },
            "3": {
                "class_type": "CLIPTextEncode",
                "inputs": {"text": negative_prompt, "clip": ["1", 1]},
            },
            "4": {"class_type": "LoadImage", "inputs": {"image": uploaded_image_name}},
            "5": {
                "class_type": "VAEEncode",
                "inputs": {"pixels": ["4", 0], "vae": ["1", 2]},
            },
            "6": {
                "class_type": "RepeatLatentBatch",
                "inputs": {"samples": ["5", 0], "amount": max(1, min(4, n))},
            },
            "7": {
                "class_type": "KSampler",
                "inputs": {
                    "seed": seed,
                    "steps": steps,
                    "cfg": cfg,
                    "sampler_name": COMFYUI_DEFAULT_SAMPLER,
                    "scheduler": COMFYUI_DEFAULT_SCHEDULER,
                    "denoise": denoise,
                    "model": ["1", 0],
                    "positive": ["2", 0],
                    "negative": ["3", 0],
                    "latent_image": ["6", 0],
                },
            },
            "8": {"class_type": "VAEDecode", "inputs": {"samples": ["7", 0], "vae": ["1", 2]}},
            "9": {
                "class_type": "SaveImage",
                "inputs": {"filename_prefix": COMFYUI_OUTPUT_PREFIX, "images": ["8", 0]},
            },
        }

    def _upload_input_image(upload: UploadFile) -> str:
        upload_name = os.path.basename(upload.filename or "input.png")
        files = {
            "image": (
                upload_name,
                upload.file,
                upload.content_type or "application/octet-stream",
            )
        }
        data = {"type": "input", "overwrite": "true"}
        try:
            response = requests.post(
                f"{COMFYUI_BASE_URL}/upload/image",
                files=files,
                data=data,
                timeout=COMFYUI_TIMEOUT_SECONDS,
            )
        except Exception as exc:
            raise HTTPException(status_code=502, detail=f"Image upload to ComfyUI failed: {exc}")

        if response.status_code >= 400:
            raise HTTPException(
                status_code=502,
                detail=f"ComfyUI upload error {response.status_code}: {response.text[:300]}",
            )
        try:
            payload = response.json()
        except Exception as exc:
            raise HTTPException(status_code=502, detail=f"Bad upload response from ComfyUI: {exc}")

        image_name = payload.get("name")
        if not image_name:
            raise HTTPException(status_code=502, detail="ComfyUI upload did not return image name")
        return str(image_name)

    @app.get("/healthz")
    def healthz():
        return {"ok": True}

    @app.get("/v1/models")
    def list_models():
        data = []
        seen = set()
        for model_id, ckpt in MODEL_MAP.items():
            data.append({"id": model_id, "object": "model", "owned_by": "local", "ckpt": ckpt})
            seen.add(model_id)
        if COMFYUI_DEFAULT_CHECKPOINT not in seen:
            data.append(
                {
                    "id": COMFYUI_DEFAULT_CHECKPOINT,
                    "object": "model",
                    "owned_by": "local",
                }
            )
        return {"object": "list", "data": data}

    @app.post("/v1/images/generations")
    async def generate_image(payload: Dict[str, Any]):
        prompt = str(payload.get("prompt", "")).strip()
        if not prompt:
            raise HTTPException(status_code=400, detail="prompt is required")

        model = payload.get("model")
        checkpoint = _resolve_checkpoint(model)
        negative_prompt = str(payload.get("negative_prompt", COMFYUI_DEFAULT_NEGATIVE))
        width, height = _size_to_dims(payload.get("size"))
        n = int(payload.get("n", 1))
        seed = int(payload.get("seed", random.randint(1, 2**31 - 1)))
        steps = int(payload.get("steps", COMFYUI_DEFAULT_STEPS))
        cfg = float(payload.get("cfg_scale", COMFYUI_DEFAULT_CFG))

        workflow = _build_text2img_workflow(
            checkpoint=checkpoint,
            prompt=prompt,
            negative_prompt=negative_prompt,
            width=width,
            height=height,
            seed=seed,
            steps=steps,
            cfg=cfg,
            n=n,
        )
        prompt_id = _queue_prompt(workflow)
        images = _wait_for_images(prompt_id)

        response_items = []
        for image in images[: max(1, min(4, n))]:
            response_items.append({"b64_json": _fetch_image_b64(image)})

        return JSONResponse(
            {
                "created": int(time.time()),
                "data": response_items,
                "model": checkpoint,
            }
        )

    @app.post("/v1/images/edits")
    async def edit_image(
        image: UploadFile = File(...),
        prompt: str = Form(...),
        model: Optional[str] = Form(default=None),
        n: int = Form(default=1),
        size: Optional[str] = Form(default=None),
        negative_prompt: Optional[str] = Form(default=None),
        denoise: Optional[float] = Form(default=None),
        steps: Optional[int] = Form(default=None),
        cfg_scale: Optional[float] = Form(default=None),
        seed: Optional[int] = Form(default=None),
    ):
        prompt = str(prompt or "").strip()
        if not prompt:
            raise HTTPException(status_code=400, detail="prompt is required")

        checkpoint = _resolve_checkpoint(model)
        _ = _size_to_dims(size)  # Kept for interface compatibility.
        negative = (negative_prompt or COMFYUI_DEFAULT_NEGATIVE).strip()
        denoise_value = float(denoise if denoise is not None else COMFYUI_DEFAULT_DENOISE)
        denoise_value = max(0.0, min(1.0, denoise_value))
        steps_value = int(steps if steps is not None else COMFYUI_DEFAULT_STEPS)
        cfg_value = float(cfg_scale if cfg_scale is not None else COMFYUI_DEFAULT_CFG)
        seed_value = int(seed if seed is not None else random.randint(1, 2**31 - 1))

        uploaded_image = _upload_input_image(image)

        workflow = _build_img2img_workflow(
            checkpoint=checkpoint,
            prompt=prompt,
            negative_prompt=negative,
            uploaded_image_name=uploaded_image,
            seed=seed_value,
            steps=steps_value,
            cfg=cfg_value,
            denoise=denoise_value,
            n=n,
        )
        prompt_id = _queue_prompt(workflow)
        images = _wait_for_images(prompt_id)

        response_items = []
        for image_ref in images[: max(1, min(4, n))]:
            response_items.append({"b64_json": _fetch_image_b64(image_ref)})

        return JSONResponse(
            {
                "created": int(time.time()),
                "data": response_items,
                "model": checkpoint,
            }
        )
