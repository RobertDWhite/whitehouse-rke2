apiVersion: apps/v1
kind: Deployment
metadata:
  name: localai-image-proxy
  namespace: ai-stack
  labels:
    app.kubernetes.io/part-of: ai-stack
    managed-by: argocd
spec:
  replicas: 1
  selector:
    matchLabels:
      app: localai-image-proxy
      app.kubernetes.io/part-of: ai-stack
      managed-by: argocd
  template:
    metadata:
      labels:
        app: localai-image-proxy
        app.kubernetes.io/part-of: ai-stack
        managed-by: argocd
    spec:
      containers:
        - name: proxy
          image: python:3.12-alpine
          command:
            - /bin/sh
            - -lc
          args:
            - |
              python -m pip install --no-cache-dir \
                fastapi==0.115.12 \
                uvicorn==0.32.1 \
                python-multipart==0.0.20 \
                requests==2.32.3 && \
              uvicorn server:app --host 0.0.0.0 --port 8080 --app-dir /app
          env:
            - name: COMFYUI_BASE_URL
              value: "http://comfyui:8188"
            - name: COMFYUI_DEFAULT_CHECKPOINT
              value: "DreamShaper_8_pruned.safetensors"
            - name: COMFYUI_MODEL_MAP
              value: '{"dreamshaper":"DreamShaper_8_pruned.safetensors"}'
            - name: COMFYUI_DEFAULT_NEGATIVE_PROMPT
              value: "low quality, blurry, artifacts, watermark, text"
            - name: COMFYUI_DEFAULT_STEPS
              value: "28"
            - name: COMFYUI_DEFAULT_CFG
              value: "7.0"
            - name: COMFYUI_DEFAULT_DENOISE
              value: "0.55"
            - name: COMFYUI_TIMEOUT_SECONDS
              value: "300"
          ports:
            - containerPort: 8080
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          volumeMounts:
            - name: config
              mountPath: /app/server.py
              subPath: server.py
      volumes:
        - name: config
          configMap:
            name: localai-image-proxy-config
