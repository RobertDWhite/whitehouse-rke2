apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: crowdsec
  namespace: argocd
spec:
  project: default
  sources:
    - repoURL: git@github.com:RobertDWhite/whitehouse-rke2.git
      targetRevision: main
      path: crowdsec
      kustomize: {}
    - chart: crowdsec
      repoURL: https://crowdsecurity.github.io/helm-charts
      targetRevision: 0.16.0
      helm:
        values: |
          container_runtime: containerd

          config:
            config.yaml.local: |
              api:
                server:
                  auto_registration:
                    enabled: true

          agent:
            acquisition:
              - namespace: kube-system
                podName: rke2-ingress-nginx-controller-*
                program: nginx
            env:
              - name: COLLECTIONS
                value: "crowdsecurity/linux crowdsecurity/nginx crowdsecurity/base-http-scenarios crowdsecurity/http-cve"

          lapi:
            env:
              - name: ENROLL_KEY
                valueFrom:
                  secretKeyRef:
                    name: crowdsec-enroll
                    key: ENROLL_KEY
              - name: ENROLL_INSTANCE_NAME
                valueFrom:
                  secretKeyRef:
                    name: crowdsec-enroll
                    key: ENROLL_INSTANCE_NAME
            persistentVolume:
              data:
                enabled: true
                storageClassName: longhorn
                size: 2Gi
              config:
                enabled: true
                storageClassName: longhorn
                size: 100Mi
            metrics:
              enabled: true
              serviceMonitor:
                enabled: false

            dashboard:
              enabled: false
  destination:
    server: https://kubernetes.default.svc
    namespace: crowdsec
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
