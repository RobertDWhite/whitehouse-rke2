apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-state-metrics
  namespace: argocd
spec:
  project: default

  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-state-metrics
    targetRevision: 5.20.0
    helm:
      releaseName: kube-state-metrics
      values: |
        namespaceOverride: observability

        resources: {}

        prometheus:
          monitor:
            enabled: false

        extraArgs:
          - --resources=certificatesigningrequests,configmaps,cronjobs,daemonsets,deployments,endpoints,horizontalpodautoscalers,ingresses,jobs,leases,limitranges,mutatingwebhookconfigurations,namespaces,networkpolicies,nodes,persistentvolumeclaims,persistentvolumes,poddisruptionbudgets,pods,replicasets,replicationcontrollers,resourcequotas,secrets,services,statefulsets,storageclasses,validatingwebhookconfigurations,volumeattachments

        rbac:
          extraRules:
            - apiGroups:
                - aquasecurity.github.io
              resources:
                - vulnerabilityreports
                - configauditreports
                - clustervulnerabilityreports
                - clusterconfigauditreports
                - rbacassessmentreports
                - clusterrbacassessmentreports
                - sbomreports
                - clustersbomreports
              verbs:
                - list
                - watch

        customResourceState:
          enabled: true
          config:
            spec:
              resources:

                # =========================
                # Namespaced Vulnerabilities
                # =========================
                - groupVersionKind:
                    group: aquasecurity.github.io
                    version: v1alpha1
                    kind: VulnerabilityReport
                  labelsFromPath:
                    namespace: [metadata, namespace]
                  metrics:
                    - name: trivy_vulnerabilities
                      help: "Trivy CRITICAL vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, criticalCount]
                      labels:
                        severity: critical

                    - name: trivy_vulnerabilities
                      help: "Trivy HIGH vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, highCount]
                      labels:
                        severity: high

                    - name: trivy_vulnerabilities
                      help: "Trivy MEDIUM vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, mediumCount]
                      labels:
                        severity: medium

                    - name: trivy_vulnerabilities
                      help: "Trivy LOW vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, lowCount]
                      labels:
                        severity: low

                # =========================
                # Namespaced Config Audits
                # =========================
                - groupVersionKind:
                    group: aquasecurity.github.io
                    version: v1alpha1
                    kind: ConfigAuditReport
                  labelsFromPath:
                    namespace: [metadata, namespace]
                  metrics:
                    - name: trivy_configaudit_failures
                      help: "Trivy config audit failures"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, failCount]

                # =========================
                # Cluster Vulnerabilities
                # =========================
                - groupVersionKind:
                    group: aquasecurity.github.io
                    version: v1alpha1
                    kind: ClusterVulnerabilityReport
                  metrics:
                    - name: trivy_cluster_vulnerabilities
                      help: "Cluster CRITICAL vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, criticalCount]
                      labels:
                        severity: critical

                    - name: trivy_cluster_vulnerabilities
                      help: "Cluster HIGH vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, highCount]
                      labels:
                        severity: high

                    - name: trivy_cluster_vulnerabilities
                      help: "Cluster MEDIUM vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, mediumCount]
                      labels:
                        severity: medium

                    - name: trivy_cluster_vulnerabilities
                      help: "Cluster LOW vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, lowCount]
                      labels:
                        severity: low

                # =========================
                # Cluster Config Audits
                # =========================
                - groupVersionKind:
                    group: aquasecurity.github.io
                    version: v1alpha1
                    kind: ClusterConfigAuditReport
                  metrics:
                    - name: trivy_cluster_configaudit_failures
                      help: "Cluster config audit failures"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, failCount]

  destination:
    server: https://kubernetes.default.svc
    namespace: observability

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true