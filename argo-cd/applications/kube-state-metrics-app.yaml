apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-state-metrics
  namespace: argocd
spec:
  project: default

  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-state-metrics
    targetRevision: 5.20.0
    helm:
      releaseName: kube-state-metrics
      values: |
        namespaceOverride: observability

        prometheus:
          monitor:
            enabled: false

        rbac:
          extraRules:
            - apiGroups:
                - aquasecurity.github.io
              resources:
                - vulnerabilityreports
                - configauditreports
                - rbacassessmentreports
              verbs:
                - list
                - watch

        customResourceState:
          enabled: true
          config:
            spec:
              resources:
                - groupVersionKind:
                    group: aquasecurity.github.io
                    version: v1alpha1
                    kind: VulnerabilityReport
                  labelsFromPath:
                    namespace: [metadata, namespace]
                  metrics:
                    - name: trivy_vulnerabilities_critical
                      help: "Trivy CRITICAL vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, criticalCount]

                    - name: trivy_vulnerabilities_high
                      help: "Trivy HIGH vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, highCount]

                    - name: trivy_vulnerabilities_medium
                      help: "Trivy MEDIUM vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, mediumCount]

                    - name: trivy_vulnerabilities_low
                      help: "Trivy LOW vulnerabilities"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, lowCount]

                - groupVersionKind:
                    group: aquasecurity.github.io
                    version: v1alpha1
                    kind: ConfigAuditReport
                  labelsFromPath:
                    namespace: [metadata, namespace]
                  metrics:
                    - name: trivy_configaudit_failures
                      help: "Trivy config audit failures"
                      type: Gauge
                      valueFrom:
                        path: [report, summary, failCount]

  destination:
    server: https://kubernetes.default.svc
    namespace: observability

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true