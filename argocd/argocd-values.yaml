global:
  image:
    tag: v3.0.11

repoServer:
  env:
    - name: SOPS_AGE_KEY_FILE
      value: "/home/argocd/.config/sops/age/key.txt"

  volumes:
    - name: cmp-plugin-config
      configMap:
        name: ksops-cmp-plugin
    - name: cmp-plugin-bin
      emptyDir: {}
    - name: sops-age
      secret:
        secretName: sops-age

  volumeMounts:
    - name: cmp-plugin-config
      mountPath: /home/argocd/.config/argocd-cmp-server/plugins/ksops.yaml
      subPath: plugin.yaml
      readOnly: true
    - name: cmp-plugin-bin
      mountPath: /var/run/argocd
    - name: sops-age
      mountPath: /etc/sops/age
      readOnly: true
    - name: sops-age
      mountPath: /home/argocd/.config/sops/age
      readOnly: true

  initContainers:
    - name: install-ksops
      image: alpine:3.18
      command: [sh, -c]
      args:
        - |
          apk add --no-cache curl &&
          curl -L https://github.com/viaduct-ai/kustomize-sops/releases/latest/download/ksops-linux-amd64 \
          -o /var/run/argocd/ksops &&
          chmod +x /var/run/argocd/ksops
      volumeMounts:
        - name: cmp-plugin-bin
          mountPath: /var/run/argocd

  extraContainers:
    - name: cmp-server
      command: ["/var/run/argocd/argocd-cmp-server"]
      image: quay.io/argoproj/argocd:v3.0.11
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
      volumeMounts:
        - name: cmp-plugin-bin
          mountPath: /var/run/argocd
        - name: cmp-plugin-config
          mountPath: /home/argocd/.config/argocd-cmp-server/plugins/ksops.yaml
          subPath: plugin.yaml
        - name: sops-age
          mountPath: /etc/sops/age
        - name: sops-age
          mountPath: /home/argocd/.config/sops/age
