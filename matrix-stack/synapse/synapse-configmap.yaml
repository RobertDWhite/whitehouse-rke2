apiVersion: v1
kind: ConfigMap
metadata:
  name: synapse-config
  namespace: matrix
data:
  homeserver.yaml: |
    server_name: "white.fm"
    public_baseurl: "https://matrix.white.fm/"
    web_client_location: "https://element.white.fm/"
    report_stats: false
    trusted_key_servers:
      - server_name: "matrix.org"
    suppress_key_server_warning: true

    presence:
      require_auth_for_profile_requests: true
      limit_profile_requests_to_users_who_share_rooms: true
      include_profile_data_on_invite: false
      allow_public_rooms_over_federation: true
    signing_key_path: "/data/white.fm.signing.key"
    media_store_path: "/data/media_store"
    enable_registration: true
    enable_set_displayname: true
    enable_set_avatar_url: true
    enable_3pid_changes: true
    registrations_require_3pid:
      - email
    registration_shared_secret: "/secrets/registration_shared_secret"
    macaroon_secret_key: "/secrets/macaroon_secret_key"
    form_secret: "/secrets/form_secret"
    database:
      name: psycopg2
      args:
        user: "${POSTGRES_USER}"
        password: "${POSTGRES_PASSWORD}"
        database: "${POSTGRES_DB}"
        host: "${POSTGRES_HOST}"
        cp_min: 5
        cp_max: 10


    oidc_providers:
      - idp_id: microsoft
        idp_name: Microsoft
        issuer: "https://login.microsoftonline.com/9e035253-688d-45d5-b3e5-475a09de13e2/v2.0"
        client_id: "5bf5d825-347f-4078-a116-0e0bc8de4567"
        client_secret: "/secrets/oidc_client_secret"
        scopes: ["openid","profile"]
        authorization_endpoint: "https://login.microsoftonline.com/9e035253-688d-45d5-b3e5-475a09de13e2/oauth2/v2.0/authorize"
        token_endpoint: "https://login.microsoftonline.com/9e035253-688d-45d5-b3e5-475a09de13e2/oauth2/v2.0/token"
        userinfo_endpoint: "https://graph.microsoft.com/oidc/userinfo"
        user_mapping_provider:
          config:
            localpart_template: "{{ user.preferred_username.split('@')[0] }}"
            display_name_template: "{{ user.name }}"
    email:
      smtp_host: postfix
      smtp_port: 25
      enable_tls: false
      notif_from: "The White House Matrix Server <matrix@white.fm>"
      app_name: "The White House"
      enable_notifs: true
      client_base_url: "https://matrix.white.fm"
      subjects:
        message_from_person_in_room: "[%(app)s] You have a message on %(app)s from %(person)s in the %(room)s room..."
        messages_from_person: "[%(app)s] You have messages on %(app)s from %(person)s..."
        messages_in_room: "[%(app)s] You have messages on %(app)s in the %(room)s room..."
        messages_in_room_and_others: "[%(app)s] You have messages on %(app)s in the %(room)s room and others..."
        invite_from_person: "[%(app)s] %(person)s has invited you to chat on %(app)s..."
        password_reset: "[%(server_name)s] Password reset"
        email_validation: "[%(server_name)s] Validate your email"