apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: observability
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      external_labels:
        origin_prometheus: whitehouse-rke2

    scrape_configs:
      - job_name: prometheus
        static_configs:
          - targets: ["localhost:9090"]

      - job_name: unifi-poller
        static_configs:
          - targets:
              - unifi-poller.observability.svc.cluster.local:9130
      # =========================
      # Velero metrics scraping
      # =========================
      - job_name: velero
        kubernetes_sd_configs:
          - role: endpoints

        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: velero

          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: velero

          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: http-monitoring

          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
      # =========================
      # MinIO metrics scraping
      # =========================
      - job_name: minio
        scheme: https
        metrics_path: /minio/v2/metrics/cluster

        static_configs:
          - targets:
              - minio-bucket.white.fm:9000

        tls_config:
          insecure_skip_verify: true

      # =========================
      # Argo CD metrics scraping
      # =========================
      - job_name: argocd-server-metrics
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: argocd
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: argocd-server-metrics
          - source_labels: [__meta_kubernetes_service_port_name]
            action: keep
            regex: http-metrics

      - job_name: argocd-metrics
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: argocd
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: argocd-application-controller-metrics
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: http-metrics

      - job_name: argocd-repo-server
        kubernetes_sd_configs:
          - role: service
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: argocd
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: argocd-repo-server-metrics
          - source_labels: [__meta_kubernetes_service_port_name]
            action: keep
            regex: http-metrics

      # =========================
      # CoreDNS metrics scraping
      # =========================

      - job_name: coredns
        kubernetes_sd_configs:
          - role: endpoints

        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: rke2-coredns-metrics

          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: kube-system

          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: metrics

      # =========================
      # Pihole metrics scraping
      # =========================

      - job_name: pihole
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_label_app]
            action: keep
            regex: pihole-exporter

      # =========================
      # Kube-state-metrics Scraping
      # =========================

      - job_name: kube-state-metrics
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: observability

          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: kube-state-metrics

          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: http

          - target_label: origin_prometheus
            replacement: whitehouse-rke2

      # =========================
      # Kubelet and cAdvisor scraping (required by RKE2 dashboard)
      # =========================
      - job_name: kubelet
        scheme: https
        kubernetes_sd_configs:
          - role: node
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/$1/proxy/metrics
          - target_label: origin_prometheus
            replacement: whitehouse-rke2

      - job_name: cadvisor
        scheme: https
        kubernetes_sd_configs:
          - role: node
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
          - target_label: origin_prometheus
            replacement: whitehouse-rke2

      - job_name: trivy-operator
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: trivy-system
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: trivy-operator
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: metrics

      # =========================
      # ingress-nginx metrics scraping
      # =========================
      - job_name: rke2-ingress-nginx
        kubernetes_sd_configs:
          - role: pod

        scrape_interval: 15s
        scrape_timeout: 10s
        metrics_path: /metrics

        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: kube-system

          - source_labels: [__meta_kubernetes_pod_name]
            action: keep
            regex: rke2-ingress-nginx-controller-.*

          # Keep a single discovered port per pod, then rewrite to 10254.
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: http

          - source_labels: [__address__]
            action: replace
            target_label: __address__
            regex: ([^:]+)(?::\d+)?
            replacement: $1:10254

          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace

          - source_labels: [__meta_kubernetes_pod_name]
            target_label: controller_pod

          - target_label: origin_prometheus
            replacement: whitehouse-rke2

          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)

      # =========================
      # exporter data
      # =========================
      - job_name: "sonarr-exporter"
        static_configs:
          - targets: ["10.100.1.20:9707"]

      - job_name: "radarr-exporter"
        static_configs:
          - targets: ["10.100.1.20:9708"]

      - job_name: "prowlarr-exporter"
        static_configs:
          - targets: ["10.100.1.20:9709"]

      - job_name: "bazarr-exporter"
        static_configs:
          - targets: ["10.100.1.20:9712"]

      - job_name: "readarr-exporter"
        static_configs:
          - targets: ["10.100.1.20:9713"]

      # =========================
      # CrowdSec LAPI metrics
      # =========================
      - job_name: crowdsec
        static_configs:
          - targets:
              - crowdsec-service.crowdsec.svc.cluster.local:6060

      # =========================
      # CrowdSec Agent metrics
      # =========================
      - job_name: crowdsec-agents
        static_configs:
          - targets:
              - crowdsec-agent-service.crowdsec.svc.cluster.local:6060

      # =========================
      # Falco metrics scraping
      # =========================
      - job_name: falco
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: falco
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: falco
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: metrics

      - job_name: falcosidekick
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: falco
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: falco-falcosidekick
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: http

      # =========================
      # cert-manager metrics scraping
      # =========================
      - job_name: cert-manager
        kubernetes_sd_configs:
          - role: pod

        relabel_configs:
          # Only cert-manager namespace
          - source_labels: [__meta_kubernetes_namespace]
            action: keep
            regex: cert-manager

          # Only controller pods
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_component]
            action: keep
            regex: controller

          # Only metrics port (cert-manager default)
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            action: keep
            regex: "9402"

          # Metrics path
          - target_label: __metrics_path__
            replacement: /metrics

          # Preserve labels for Grafana dashboard
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)


    
