apiVersion: v1
kind: ConfigMap
metadata:
  name: channelizer-scripts
  namespace: sdr-research
data:
  channelize.py: |
    #!/usr/bin/env python3
    import os, json
    import numpy as np
    from gnuradio import gr, blocks
    import osmosdr
    from scipy.signal import find_peaks

    SAMPLE_RATE = 2_400_000
    FFT_SIZE = 4096
    CW_MAX_BW_HZ = 300
    VOICE_MIN_BW_HZ = 5000
    ENERGY_THRESHOLD_DB = -50
    CAPTURE_SECONDS = 2

    OUT_DIR = "/data/detections"
    os.makedirs(OUT_DIR, exist_ok=True)

    class Channelizer(gr.top_block):
        def __init__(self):
            gr.top_block.__init__(self, "Streaming Channelizer")

            self.src = osmosdr.source(
                args="rtl_tcp=rtl-tcp.sdr-research.svc.cluster.local:1234"
            )
            self.src.set_sample_rate(SAMPLE_RATE)
            self.src.set_gain(40)

            self.head = blocks.head(
                gr.sizeof_gr_complex,
                int(SAMPLE_RATE * CAPTURE_SECONDS)
            )
            self.sink = blocks.vector_sink_c()

            self.connect(self.src, self.head, self.sink)

        def detect(self):
            self.run()
            iq = np.array(self.sink.data())

            fft = np.fft.fftshift(np.fft.fft(iq, FFT_SIZE))
            power = 20 * np.log10(np.abs(fft) + 1e-12)
            freqs = np.fft.fftshift(
                np.fft.fftfreq(FFT_SIZE, d=1/SAMPLE_RATE)
            )

            peaks, props = find_peaks(power, height=ENERGY_THRESHOLD_DB)

            results = []
            for p in peaks:
                bw = SAMPLE_RATE / FFT_SIZE
                if bw < CW_MAX_BW_HZ:
                    mode = "CW"
                elif bw > VOICE_MIN_BW_HZ:
                    mode = "VOICE"
                else:
                    continue

                results.append({
                    "frequency_offset_hz": float(freqs[p]),
                    "bandwidth_hz": float(bw),
                    "mode": mode
                })

            return results

    if __name__ == "__main__":
        ch = Channelizer()
        detections = ch.detect()

        out = {
            "source": "rtl_tcp",
            "detections": detections
        }

        path = os.path.join(OUT_DIR, "detections.json")
        with open(path, "w") as f:
            json.dump(out, f, indent=2)

        print(f"Wrote {path}")