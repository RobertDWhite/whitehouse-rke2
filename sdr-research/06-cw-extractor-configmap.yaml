apiVersion: v1
kind: ConfigMap
metadata:
  name: cw-extractor-scripts
  namespace: sdr-research
data:
  cw_extract.py: |
    #!/usr/bin/env python3
    import os, json, wave
    import numpy as np
    from gnuradio import gr, blocks, filter
    import osmosdr

    SAMPLE_RATE = 2_400_000
    AUDIO_RATE = 8000
    CW_BW = 200

    DET_PATH = "/data/detections/detections.json"
    OUT_DIR = "/data/audio/cw"
    os.makedirs(OUT_DIR, exist_ok=True)

    class CWExtractor(gr.top_block):
        def __init__(self, offset_hz):
            gr.top_block.__init__(self, "CW Extractor")

            self.src = osmosdr.source(
                args="rtl_tcp=rtl-tcp.sdr-research.svc.cluster.local:1234"
            )
            self.src.set_sample_rate(SAMPLE_RATE)
            self.src.set_gain(40)

            self.xlate = filter.freq_xlating_fir_filter_ccf(
                decimation=int(SAMPLE_RATE / AUDIO_RATE),
                taps=filter.firdes.low_pass(
                    1.0, SAMPLE_RATE, CW_BW, 50
                ),
                center_freq=offset_hz,
                samp_rate=SAMPLE_RATE
            )

            self.mag = blocks.complex_to_mag()
            self.sink = blocks.vector_sink_f()

            self.connect(self.src, self.xlate, self.mag, self.sink)

        def run_and_get_audio(self):
            self.run()
            return np.array(self.sink.data())

    if __name__ == "__main__":
        with open(DET_PATH) as f:
            data = json.load(f)

        for d in data["detections"]:
            if d["mode"] != "CW":
                continue

            freq = d["frequency_offset_hz"]
            tb = CWExtractor(freq)
            audio = tb.run_and_get_audio()

            if np.max(audio) == 0:
                continue

            audio = (audio / np.max(audio) * 32767).astype(np.int16)

            out = os.path.join(
                OUT_DIR,
                f"cw_{int(freq)}.wav"
            )

            with wave.open(out, "w") as w:
                w.setnchannels(1)
                w.setsampwidth(2)
                w.setframerate(AUDIO_RATE)
                w.writeframes(audio.tobytes())

            print(f"Wrote {out}")