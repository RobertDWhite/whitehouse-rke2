apiVersion: v1
kind: ConfigMap
metadata:
  name: cw-decoder-scripts
  namespace: sdr-research
data:
  cw_decode.sh: |
    #!/bin/sh
    set -e

    AUDIO_DIR="/data/audio/cw"
    OUT_DIR="/data/text/cw"
    MIN_FILE_AGE_SEC="${MIN_FILE_AGE_SEC:-15}"
    # Minimum number of alphanumeric characters required to keep a decoded result
    MIN_CHARS="${MIN_CW_CHARS:-4}"

    mkdir -p "$OUT_DIR"

    for f in "$AUDIO_DIR"/*.wav; do
      [ -e "$f" ] || continue

      base=$(basename "$f" .wav)
      out="$OUT_DIR/$base.txt"
      tmp="$out.tmp"
      now=$(date +%s)
      mtime=$(stat -c %Y "$f" 2>/dev/null || stat -f %m "$f")
      age=$((now - mtime))

      if [ -f "$out" ]; then
        echo "Skipping $f (already decoded)"
        continue
      fi
      if [ "$age" -lt "$MIN_FILE_AGE_SEC" ]; then
        echo "Skipping $f (still changing: ${age}s old)"
        continue
      fi

      echo "Decoding $f"
      # Run multimon-ng; strip "CW: " prefix; keep only lines with content
      raw=$(multimon-ng -q -t wav -a CW "$f" 2>/dev/null | grep '^CW:' | sed 's/^CW: *//')

      if [ -z "$raw" ]; then
        echo "No CW detected in $f"
        continue
      fi

      # Join lines with spaces, collapse multiple spaces
      joined=$(printf '%s' "$raw" | tr '\n' ' ' | tr -s ' ' | sed 's/^ //;s/ $//')

      # Count alphanumeric characters
      alnum=$(printf '%s' "$joined" | tr -cd '[:alnum:]' | wc -c)
      if [ "$alnum" -lt "$MIN_CHARS" ]; then
        echo "Skipping $f (insufficient content: '$joined')"
        continue
      fi

      printf '%s\n' "$joined" > "$tmp"
      mv "$tmp" "$out"
      echo "CW decoded: $f -> $joined"
    done
