apiVersion: apps/v1
kind: Deployment
metadata:
  name: voice-decoder
  namespace: sdr-research
spec:
  replicas: 1
  selector:
    matchLabels:
      app: voice-decoder
  template:
    metadata:
      labels:
        app: voice-decoder
    spec:
      containers:
        - name: voice-decoder
          image: linuxserver/faster-whisper:latest
          env:
            - name: TZ
              value: UTC
          volumeMounts:
            - name: artifacts
              mountPath: /data
          command:
            - /bin/sh
            - -c
            - |
              echo "Starting voice decoder deployment"
              mkdir -p /data/text/voice

              while true; do
                for f in /data/audio/voice/*.wav; do
                  [ -f "$f" ] || continue
                  out="/data/text/voice/$(basename "$f" .wav).txt"
                  if [ ! -f "$out" ]; then
                    echo "Decoding $f"
                    python3 <<'EOF'
from faster_whisper import WhisperModel

model = WhisperModel("small", device="cpu")
segments, info = model.transcribe("$f")

with open("$out", "w") as o:
    for s in segments:
        o.write(s.text.strip() + "\n")
EOF
                  fi
                done
                sleep 5
              done
      volumes:
        - name: artifacts
          persistentVolumeClaim:
            claimName: sdr-artifacts