apiVersion: apps/v1
kind: Deployment
metadata:
  name: voice-decoder
  namespace: sdr-research
spec:
  replicas: 1
  selector:
    matchLabels:
      app: voice-decoder
  template:
    metadata:
      labels:
        app: voice-decoder
    spec:
      containers:
        - name: voice-decoder
          image: linuxserver/faster-whisper
          env:
            - name: TZ
              value: UTC
          volumeMounts:
            - name: artifacts
              mountPath: /data
          command:
            - /bin/sh
            - -c
            - |
              echo "Starting voice decoder deployment"
              mkdir -p /data/text/voice
              while true; do
                for f in /data/audio/voice/*.wav; do
                  [ -f "$f" ] || continue
                  out="/data/text/voice/$(basename "$f" .wav).txt"
                  if [ ! -f "$out" ]; then
                    echo "Decoding $f"
                    faster-whisper "$f" \
                      --model small \
                      --language en \
                      --output_format txt \
                      --output_dir /data/text/voice
                  fi
                done
                sleep 5
              done
      volumes:
        - name: artifacts
          persistentVolumeClaim:
            claimName: sdr-artifacts