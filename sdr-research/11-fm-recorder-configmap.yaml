apiVersion: v1
kind: ConfigMap
metadata:
  name: fm-recorder-scripts
  namespace: sdr-research
data:
  fm_record.py: |
    #!/usr/bin/env python3
    import os, time
    from gnuradio import gr, blocks, filter, analog
    import osmosdr

    CENTER_FREQ = 145_500_000     # 145.500 MHz
    SAMPLE_RATE = 2_400_000
    AUDIO_RATE = 48_000
    FM_DEVIATION = 75_000

    OUT_DIR = "/data/audio/voice"
    os.makedirs(OUT_DIR, exist_ok=True)

    class FMRecorder(gr.top_block):
        def __init__(self, outfile):
            gr.top_block.__init__(self, "FM Voice Recorder")

            self.src = osmosdr.source(
                args="rtl_tcp=rtl-tcp.sdr-research.svc.cluster.local:1234"
            )
            self.src.set_sample_rate(SAMPLE_RATE)
            self.src.set_center_freq(CENTER_FREQ)
            self.src.set_gain_mode(True)

            # Channel filter (200 kHz)
            chan_width = 200_000
            lpf = filter.firdes.low_pass(
                1.0,
                SAMPLE_RATE,
                chan_width / 2,
                chan_width / 10
            )

            self.xlating = filter.freq_xlating_fir_filter_ccf(
                int(SAMPLE_RATE / 240_000),
                lpf,
                0,
                SAMPLE_RATE
            )

            self.wbfm = analog.wfm_rcv(
                quad_rate=240_000,
                audio_decimation=int(240_000 / AUDIO_RATE)
            )

            self.sink = blocks.wavfile_sink(
                outfile,
                1,
                AUDIO_RATE,
                blocks.FORMAT_WAV
            )

            self.connect(self.src, self.xlating, self.wbfm, self.sink)

    if __name__ == "__main__":
        ts = int(time.time())
        outfile = f"{OUT_DIR}/145500000_{ts}.wav"
        print(f"Recording FM to {outfile}")

        tb = FMRecorder(outfile)
        tb.start()

        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            pass

        tb.stop()
        tb.wait()