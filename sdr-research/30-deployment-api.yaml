apiVersion: apps/v1
kind: Deployment
metadata:
  name: sdr-viewer-api
  namespace: sdr-research
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: sdr-viewer-api
  template:
    metadata:
      labels:
        app: sdr-viewer-api
      annotations:
        kubectl.kubernetes.io/restartedAt: "2026-02-26T04:00:00Z"
    spec:
      nodeSelector:
        kubernetes.io/hostname: rke2-node-14
      containers:
        - name: api
          image: registry.white.fm/sdr-viewer-api
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: sdr-viewer-secrets
                  key: database-url
            - name: CALLSIGN_HINTS
              value: "w3rdw"
            - name: AUTO_DELETE_NO_SPEECH
              value: "true"
            - name: OLLAMA_ENABLED
              value: "true"
            - name: OLLAMA_URL
              value: "http://ollama.ai-stack.svc.cluster.local:11434"
            - name: OLLAMA_MODEL
              value: "llama3.1:8b"
            - name: OLLAMA_TIMEOUT_SECONDS
              value: "20"
            - name: OLLAMA_MAX_TAGS
              value: "8"
            - name: OLLAMA_MAX_PER_CYCLE
              value: "40"
            - name: HAMDB_ENABLED
              value: "true"
            - name: HAMDB_MAX_PER_CYCLE
              value: "10"
            - name: HAMDB_CACHE_DAYS
              value: "30"
            - name: AUDIO_BASE_PATH
              value: /data/audio
            - name: TEXT_BASE_PATH
              value: /data/text
            - name: CACHE_PATH
              value: /tmp/sdr-viewer-cache
            - name: REPEATERBOOK_ENABLED
              value: "true"
            - name: REPEATERBOOK_EMAIL
              valueFrom:
                secretKeyRef:
                  name: sdr-viewer-secrets
                  key: repeaterbook-email
            - name: REPEATERBOOK_LATITUDE
              valueFrom:
                secretKeyRef:
                  name: sdr-viewer-secrets
                  key: repeaterbook-latitude
            - name: REPEATERBOOK_LONGITUDE
              valueFrom:
                secretKeyRef:
                  name: sdr-viewer-secrets
                  key: repeaterbook-longitude
            - name: REPEATERBOOK_RADIUS_MILES
              value: "75"
            - name: REPEATERBOOK_STATES
              value: "OH,IN,KY"
            - name: REPEATERBOOK_SYNC_HOURS
              value: "24"
            - name: ALERT_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: sdr-viewer-secrets
                  key: alert-webhook-url
            - name: ALERT_CALLSIGNS
              valueFrom:
                secretKeyRef:
                  name: sdr-viewer-secrets
                  key: alert-callsigns
            - name: ALERT_KEYWORDS
              valueFrom:
                secretKeyRef:
                  name: sdr-viewer-secrets
                  key: alert-keywords
          volumeMounts:
            - name: sdr-artifacts
              mountPath: /data
              readOnly: true
            - name: cache
              mountPath: /cache
            - name: api-overrides
              mountPath: /app/app/services/audio.py
              subPath: audio.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/routers/files.py
              subPath: files.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/routers/search.py
              subPath: search.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/services/tagging.py
              subPath: tagging.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/services/known_freqs.py
              subPath: known_freqs.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/routers/repeaters.py
              subPath: repeaters.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/services/indexer.py
              subPath: indexer.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/routers/aprs.py
              subPath: aprs.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/routers/admin.py
              subPath: admin.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/routers/stats.py
              subPath: stats.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/services/alerting.py
              subPath: alerting.py
              readOnly: true
            - name: api-overrides
              mountPath: /app/app/services/metrics.py
              subPath: metrics.py
              readOnly: true
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 2000m
              memory: 4Gi
          livenessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  TS=$(cat /tmp/indexer_heartbeat 2>/dev/null || echo 0)
                  NOW=$(date +%s)
                  test $(( NOW - ${TS%.*} )) -lt 600
            initialDelaySeconds: 300
            periodSeconds: 60
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /api/v1/health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: sdr-artifacts
          persistentVolumeClaim:
            claimName: sdr-artifacts-rwx
        - name: cache
          persistentVolumeClaim:
            claimName: sdr-viewer-cache
        - name: api-overrides
          configMap:
            name: sdr-viewer-api-overrides
            defaultMode: 0444
