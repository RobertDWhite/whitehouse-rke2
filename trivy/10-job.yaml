apiVersion: batch/v1
kind: Job
metadata:
  name: trivy-rke2-scan
  namespace: trivy
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/sync-wave: "1"

    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation

spec:
  backoffLimit: 0
  template:
    spec:
      serviceAccountName: trivy
      restartPolicy: Never
      containers:
        - name: trivy
          image: aquasec/trivy:0.68.2
          command:
            - trivy
            - k8s
            - --disable-node-collector
            - --scanners
            - vuln,misconfig,secret,rbac
            - --severity
            - HIGH,CRITICAL
            - --report
            - summary
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
